<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Parma 2027 - Dashboard</title>
<style>
  /* --- Apple-Style Design Tokens --- */
  :root {
    --bg-color: #F5F5F7; 
    --column-bg: rgba(255, 255, 255, 0.6);
    --card-bg: #FFFFFF;
    --text-primary: #1D1D1F;
    --text-secondary: #86868B;
    --border-radius-lg: 18px;
    --border-radius-sm: 10px;
    --shadow: 0 4px 14px rgba(0, 0, 0, 0.05);
    --shadow-hover: 0 8px 24px rgba(0, 0, 0, 0.12);
  }

  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    background-color: var(--bg-color);
    color: var(--text-primary);
    margin: 0;
    padding: 0;
    height: 100vh;
    display: flex;
    flex-direction: column;
    overflow: hidden; 
  }

  /* --- Top Navigation / Header --- */
  .app-header {
    padding: 20px 40px;
    background: rgba(245, 245, 247, 0.8);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border-bottom: 1px solid rgba(0,0,0,0.05);
    z-index: 10;
  }
  
  .app-title {
    margin: 0;
    font-size: 24px;
    font-weight: 600;
    letter-spacing: -0.5px;
  }

  /* --- Board & Columns --- */
  .board-wrapper {
    flex: 1;
    padding: 40px;
    overflow-x: auto;
    overflow-y: auto;
  }

  .board {
    display: flex;
    gap: 24px;
    align-items: flex-start;
    min-width: max-content; 
  }

  .column {
    background: var(--column-bg);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border-radius: var(--border-radius-lg);
    box-shadow: var(--shadow);
    padding: 20px;
    min-width: 320px;
    width: 320px;
    resize: horizontal; 
    overflow: hidden;
    display: flex;
    flex-direction: column;
    gap: 16px;
    border: 1px solid rgba(255,255,255,0.4);
    min-height: 400px;
  }

  .col-todo {
    min-width: 600px;
    width: 600px;
  }

  /* --- Headers & Colors --- */
  .column-header {
    margin-bottom: 8px;
  }
  
  .column-title {
    margin: 0;
    font-size: 20px;
    font-weight: 600;
    letter-spacing: -0.3px;
  }

  .col-updates .column-title { color: #007AFF; }
  .col-todo .column-title { color: #FF9500; }   
  .col-events .column-title { color: #AF52DE; } 
  .col-editoriale .column-title { color: #FF2D55; }
  .col-info .column-title { color: #34C759; }   

  /* --- Split Board Logic --- */
  .split-board {
    display: flex;
    gap: 24px;
    flex: 1;
    height: 100%;
  }

  .sub-column {
    flex: 1;
    display: flex;
    flex-direction: column;
    min-width: 260px;
  }

  .sub-column-title {
    font-size: 13px;
    color: var(--text-secondary);
    font-weight: 600;
    margin: 0 0 12px 0;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  /* --- Cards & Tasks --- */
  .card-container {
    display: flex;
    flex-direction: column;
    gap: 12px;
    flex: 1;
    min-height: 50px; 
    padding-bottom: 12px;
  }

  .card {
    background: var(--card-bg);
    border-radius: var(--border-radius-sm);
    padding: 16px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    cursor: grab;
    transition: transform 0.2s ease, box-shadow 0.2s ease, outline 0.2s ease;
    border: 1px solid rgba(0,0,0,0.03);
    position: relative;
  }

  .card:hover {
    box-shadow: var(--shadow-hover);
  }

  .card:active {
    cursor: grabbing;
    transform: scale(1.02);
    box-shadow: var(--shadow-hover);
    z-index: 100;
  }

  .card-title {
    margin: 0 0 4px 0;
    font-size: 16px;
    font-weight: 600;
    line-height: 1.3;
  }

  /* Rounded pill design for subtitle/date */
  .card-subtitle {
    margin: 0 0 10px 0;
    font-size: 11px;
    color: var(--text-secondary);
    font-weight: 600;
    display: inline-block;
    padding: 4px 10px;
    border: 1px solid rgba(0,0,0,0.1);
    border-radius: 12px;
    background: rgba(0,0,0,0.02);
  }

  .card-body {
    margin: 0 0 16px 0;
    font-size: 14px;
    color: #333336;
    line-height: 1.4;
    white-space: pre-wrap; 
  }

  /* --- Assignee Dropdown --- */
  .assignee-select {
    appearance: none;
    background-color: #F5F5F7;
    border: 1px solid rgba(0,0,0,0.05);
    padding: 6px 14px;
    border-radius: 20px;
    font-size: 13px;
    font-weight: 600;
    color: var(--text-secondary);
    cursor: pointer;
    font-family: inherit;
    outline: none;
    transition: all 0.2s;
    margin-top: 8px; 
  }

  .assignee-select:hover {
    background-color: #E8E8ED;
    color: var(--text-primary);
  }

  .assignee-select:focus {
    box-shadow: 0 0 0 2px #007AFF;
    color: var(--text-primary);
  }

  /* --- Add Button --- */
  .add-btn {
    background: transparent;
    border: none;
    color: var(--text-secondary);
    font-size: 14px;
    font-weight: 500;
    text-align: left;
    padding: 12px 0 0 0;
    cursor: pointer;
    font-family: inherit;
    transition: color 0.2s;
    border-top: 1px solid rgba(0,0,0,0.05);
    margin-top: auto;
  }

  .add-btn:hover {
    color: var(--text-primary);
  }

  /* --- Custom Modal --- */
  .modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.2);
    backdrop-filter: blur(5px);
    -webkit-backdrop-filter: blur(5px);
    z-index: 1000;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .modal-overlay.active {
    display: flex;
    opacity: 1;
  }

  .modal-content {
    background: #ffffff;
    padding: 30px;
    border-radius: var(--border-radius-lg);
    box-shadow: var(--shadow-hover);
    width: 90%;
    max-width: 450px;
    transform: scale(0.95);
    transition: transform 0.3s ease;
  }

  .modal-overlay.active .modal-content {
    transform: scale(1);
  }

  .modal-content h3 {
    margin: 0 0 24px 0;
    font-size: 20px;
  }

  .input-group {
    margin-bottom: 16px;
    text-align: left;
  }

  .input-group label {
    display: block;
    font-size: 12px;
    font-weight: 600;
    color: var(--text-secondary);
    margin-bottom: 6px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .modal-content input, .modal-content textarea {
    width: 100%;
    padding: 12px 16px;
    border: 1px solid #E5E5EA;
    border-radius: var(--border-radius-sm);
    font-size: 15px;
    font-family: inherit;
    box-sizing: border-box;
    outline: none;
    transition: border-color 0.2s;
    resize: vertical;
  }

  .modal-content input:focus, .modal-content textarea:focus {
    border-color: #007AFF;
  }

  /* Color Picker UI */
  .color-picker {
    display: flex;
    gap: 12px;
    margin-top: 8px;
  }

  .color-swatch {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    cursor: pointer;
    border: 2px solid transparent;
    transition: transform 0.2s, border-color 0.2s, box-shadow 0.2s;
  }

  .color-swatch.selected {
    transform: scale(1.15);
    border-color: rgba(0,0,0,0.1);
    box-shadow: 0 0 0 3px white inset;
  }

  .modal-actions {
    display: flex;
    align-items: center;
    justify-content: flex-end;
    gap: 12px;
    margin-top: 24px;
  }

  .modal-btn {
    padding: 10px 20px;
    border-radius: 20px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    border: none;
    font-family: inherit;
    transition: background-color 0.2s;
  }

  .modal-btn.cancel {
    background: #F5F5F7;
    color: var(--text-primary);
  }

  .modal-btn.cancel:hover {
    background: #E8E8ED;
  }

  .modal-btn.primary {
    background: #007AFF;
    color: white;
  }

  .modal-btn.primary:hover {
    background: #0066D6;
  }
  
  .card-container.drag-over {
    background: rgba(0,0,0,0.02);
    border-radius: var(--border-radius-sm);
  }

</style>
</head>
<body>

<div class="app-header">
  <h1 class="app-title">Parma 2027 - dashboard comunicazione</h1>
</div>

<div class="board-wrapper">
  <div class="board">
    
    <!-- Column 1: Latest Updates -->
    <div class="column col-updates">
      <div class="column-header">
        <h2 class="column-title">Latest updates</h2>
      </div>
      <div class="card-container" id="updates" ondragover="window.allowDrop(event)" ondrop="window.drop(event)" ondragenter="window.dragEnter(event)" ondragleave="window.dragLeave(event)">
        
        <div class="card" draggable="true" ondragstart="window.drag(event)" id="card1">
          <p class="card-title" style="color: #007AFF;" data-color="#007AFF">Strategia Brand Identity</p>
          <p class="card-subtitle">Riassunto riunione 22/02/2026</p>
          <p class="card-body">MATE ha evidenziato la necessit√† di un'identit√† forte che vada oltre la sigla "EYC". Volont√† di risolvere alcune criticit√† del logo. Apprezzata l'idea di usare la simbologia, anche quella delle "4 vie".</p>
          <select class="assignee-select">
            <option value="" disabled>Assegna a...</option>
            <option value="inc">INC</option>
            <option value="mate" selected>MATE</option>
            <option value="zollo">Zollo</option>
            <option value="clg">CLG</option>
            <option value="comitato">Comitato</option>
            <option value="tutti">Tutti</option>
          </select>
        </div>

        <div class="card" draggable="true" ondragstart="window.drag(event)" id="card2">
          <p class="card-title" style="color: #007AFF;" data-color="#007AFF">Gestione Media e Portavoci</p>
          <p class="card-body">- Media tradizionali: Assessora Aimi e rappresentante giovani (formazione INC).<br>- Social Media: approccio corale, assegnare giovani a ogni "piazza".</p>
          <select class="assignee-select">
            <option value="" disabled>Assegna a...</option>
            <option value="inc" selected>INC</option>
            <option value="mate">MATE</option>
            <option value="zollo">Zollo</option>
            <option value="clg">CLG</option>
            <option value="comitato">Comitato</option>
            <option value="tutti">Tutti</option>
          </select>
        </div>

        <div class="card" draggable="true" ondragstart="window.drag(event)" id="card3">
          <p class="card-title" style="color: #007AFF;" data-color="#007AFF">Ruoli e Supervisione</p>
          <p class="card-body">INC manterr√† stabilmente il ruolo di riferimento principale per la supervisione strategica e dei contenuti.</p>
          <select class="assignee-select">
            <option value="" disabled>Assegna a...</option>
            <option value="inc" selected>INC</option>
            <option value="mate">MATE</option>
            <option value="zollo">Zollo</option>
            <option value="clg">CLG</option>
            <option value="comitato">Comitato</option>
            <option value="tutti">Tutti</option>
          </select>
        </div>

      </div>
      <button class="add-btn" onclick="window.openAddModal('updates')">+ Add update</button>
    </div>

    <!-- Column 2: To Do List -->
    <div class="column col-todo">
      <div class="column-header">
        <h2 class="column-title">To do list</h2>
      </div>
      <div class="split-board">
        <div class="sub-column">
          <h3 class="sub-column-title">Short Term</h3>
          <div class="card-container" id="todo-short" ondragover="window.allowDrop(event)" ondrop="window.drop(event)" ondragenter="window.dragEnter(event)" ondragleave="window.dragLeave(event)">
            
            <div class="card" draggable="true" ondragstart="window.drag(event)" id="card4">
              <p class="card-title" style="color: #FF9500;" data-color="#FF9500">Grafica e Identit√†</p>
              <p class="card-subtitle">Entro questa settimana</p>
              <p class="card-body">MATE definisce la timeline di sviluppo con i grafici vincitori, apporta gli aggiustamenti al logo e inizia a "esplodere" brand identity. Creare nuova carta intestata.</p>
              <select class="assignee-select">
                <option value="" disabled>Assegna a...</option>
                <option value="inc">INC</option>
                <option value="mate" selected>MATE</option>
                <option value="zollo">Zollo</option>
                <option value="clg">CLG</option>
                <option value="comitato">Comitato</option>
                <option value="tutti">Tutti</option>
              </select>
            </div>

            <div class="card" draggable="true" ondragstart="window.drag(event)" id="card5">
              <p class="card-title" style="color: #FF9500;" data-color="#FF9500">Sito Web e Concept</p>
              <p class="card-body">MATE e Zollo mettono online un sito web temporaneo. Feedback con il CLG sulla brand identity e sui claim.</p>
              <select class="assignee-select">
                <option value="" disabled>Assegna a...</option>
                <option value="inc">INC</option>
                <option value="mate">MATE</option>
                <option value="zollo" selected>Zollo</option>
                <option value="clg">CLG</option>
                <option value="comitato">Comitato</option>
                <option value="tutti">Tutti</option>
              </select>
            </div>

            <div class="card" draggable="true" ondragstart="window.drag(event)" id="card6">
              <p class="card-title" style="color: #FF9500;" data-color="#FF9500">Task Riunione Mercoled√¨</p>
              <p class="card-body">- Decidere identit√† visiva "di transizione".<br>- Scegliere tool gestionale calendario/materiali.<br>- Calendarizzare confronto Comitato.<br>- Definire specifiche digitali.</p>
              <select class="assignee-select">
                <option value="" disabled>Assegna a...</option>
                <option value="inc">INC</option>
                <option value="mate">MATE</option>
                <option value="zollo">Zollo</option>
                <option value="clg">CLG</option>
                <option value="comitato">Comitato</option>
                <option value="tutti" selected>Tutti</option>
              </select>
            </div>

            <div class="card" draggable="true" ondragstart="window.drag(event)" id="card7">
              <p class="card-title" style="color: #FF9500;" data-color="#FF9500">Team Volontari</p>
              <p class="card-subtitle">Avvio Immediato</p>
              <p class="card-body">Creare il gruppo WhatsApp, allargare la base dei volontari e iniziare a lavorare con il supporto di editing di Zollo.</p>
              <select class="assignee-select">
                <option value="" disabled>Assegna a...</option>
                <option value="inc">INC</option>
                <option value="mate">MATE</option>
                <option value="zollo" selected>Zollo</option>
                <option value="clg">CLG</option>
                <option value="comitato">Comitato</option>
                <option value="tutti">Tutti</option>
              </select>
            </div>

          </div>
          <button class="add-btn" onclick="window.openAddModal('todo-short')">+ Add short term</button>
        </div>
        
        <div class="sub-column">
          <h3 class="sub-column-title">Long Term</h3>
          <div class="card-container" id="todo-long" ondragover="window.allowDrop(event)" ondrop="window.drop(event)" ondragenter="window.dragEnter(event)" ondragleave="window.dragLeave(event)">
            
            <div class="card" draggable="true" ondragstart="window.drag(event)" id="card8">
              <p class="card-title" style="color: #1D1D1F;" data-color="#1D1D1F">Evento Media di Lancio</p>
              <p class="card-subtitle">Settembre 2026</p>
              <p class="card-body">Organizzare un grande evento invitando la stampa nazionale ed europea. Preparare in anticipo materiali e storie.</p>
              <select class="assignee-select">
                <option value="" disabled>Assegna a...</option>
                <option value="inc" selected>INC</option>
                <option value="mate">MATE</option>
                <option value="zollo">Zollo</option>
                <option value="clg">CLG</option>
                <option value="comitato">Comitato</option>
                <option value="tutti">Tutti</option>
              </select>
            </div>

            <div class="card" draggable="true" ondragstart="window.drag(event)" id="card9">
              <p class="card-title" style="color: #1D1D1F;" data-color="#1D1D1F">Lancio Sito Web Ufficiale</p>
              <p class="card-subtitle">Settembre 2026</p>
              <p class="card-body">Pubblicare il nuovo sito definitivo, aggiornato e pienamente operativo. Fissare call per elementi tecnici.</p>
              <select class="assignee-select">
                <option value="" disabled>Assegna a...</option>
                <option value="inc">INC</option>
                <option value="mate" selected>MATE</option>
                <option value="zollo">Zollo</option>
                <option value="clg">CLG</option>
                <option value="comitato">Comitato</option>
                <option value="tutti">Tutti</option>
              </select>
            </div>

            <div class="card" draggable="true" ondragstart="window.drag(event)" id="card10">
              <p class="card-title" style="color: #1D1D1F;" data-color="#1D1D1F">Team Content-Creators</p>
              <p class="card-subtitle">Sett 2026 in poi</p>
              <p class="card-body">Guidare l'evoluzione del gruppo di volontari fino alla creazione del "gruppo di giovani dell'hub creativo". Valutare tirocini. Strutturare call.</p>
              <select class="assignee-select">
                <option value="" disabled>Assegna a...</option>
                <option value="inc">INC</option>
                <option value="mate">MATE</option>
                <option value="zollo" selected>Zollo</option>
                <option value="clg">CLG</option>
                <option value="comitato">Comitato</option>
                <option value="tutti">Tutti</option>
              </select>
            </div>

            <div class="card" draggable="true" ondragstart="window.drag(event)" id="card11">
              <p class="card-title" style="color: #1D1D1F;" data-color="#1D1D1F">Avvio Anno Capitale</p>
              <p class="card-subtitle">Da Settembre in poi</p>
              <p class="card-body">Essere pronti a regime con la task force di comunicazione.</p>
              <select class="assignee-select">
                <option value="" disabled>Assegna a...</option>
                <option value="inc">INC</option>
                <option value="mate">MATE</option>
                <option value="zollo">Zollo</option>
                <option value="clg">CLG</option>
                <option value="comitato">Comitato</option>
                <option value="tutti" selected>Tutti</option>
              </select>
            </div>

          </div>
          <button class="add-btn" onclick="window.openAddModal('todo-long')">+ Add long term</button>
        </div>
      </div>
    </div>

    <!-- Column 3: Next Events -->
    <div class="column col-events">
      <div class="column-header">
        <h2 class="column-title">Next events</h2>
      </div>
      <div class="card-container" id="events" ondragover="window.allowDrop(event)" ondrop="window.drop(event)" ondragenter="window.dragEnter(event)" ondragleave="window.dragLeave(event)">
        
        <div class="card" draggable="true" ondragstart="window.drag(event)" id="card12">
          <p class="card-title" style="color: #AF52DE;" data-color="#AF52DE">Evento con Ministro Zangrillo</p>
          <p class="card-subtitle">3 Marzo 2026</p>
          <p class="card-body">INC raccoglie e prepara i testi per la stampa.</p>
          <select class="assignee-select">
            <option value="" disabled>Assegna a...</option>
            <option value="inc" selected>INC</option>
            <option value="mate">MATE</option>
            <option value="zollo">Zollo</option>
            <option value="clg">CLG</option>
            <option value="comitato">Comitato</option>
            <option value="tutti">Tutti</option>
          </select>
        </div>

        <div class="card" draggable="true" ondragstart="window.drag(event)" id="card13">
          <p class="card-title" style="color: #AF52DE;" data-color="#AF52DE">Workshop Universitario</p>
          <p class="card-subtitle">6 Marzo 2026</p>
          <p class="card-body">140 giovani europei. Zollo attiva subito i volontari CLG per formare un gruppo di comunicazione operativo temporaneo.</p>
          <select class="assignee-select">
            <option value="" disabled>Assegna a...</option>
            <option value="inc">INC</option>
            <option value="mate">MATE</option>
            <option value="zollo" selected>Zollo</option>
            <option value="clg">CLG</option>
            <option value="comitato">Comitato</option>
            <option value="tutti">Tutti</option>
          </select>
        </div>

      </div>
      <button class="add-btn" onclick="window.openAddModal('events')">+ Add event</button>
    </div>

    <!-- Column 4: Piano Editoriale -->
    <div class="column col-editoriale">
      <div class="column-header">
        <h2 class="column-title">Piano editoriale</h2>
      </div>
      <div class="card-container" id="editoriale" ondragover="window.allowDrop(event)" ondrop="window.drop(event)" ondragenter="window.dragEnter(event)" ondragleave="window.dragLeave(event)">
        <!-- Empty drop zone -->
      </div>
      <button class="add-btn" onclick="window.openAddModal('editoriale')">+ Add post</button>
    </div>

    <!-- Column 5: Info Importanti -->
    <div class="column col-info">
      <div class="column-header">
        <h2 class="column-title">info importanti</h2>
      </div>
      <div class="card-container" id="info" ondragover="window.allowDrop(event)" ondrop="window.drop(event)" ondragenter="window.dragEnter(event)" ondragleave="window.dragLeave(event)">
        <!-- Empty drop zone -->
      </div>
      <button class="add-btn" onclick="window.openAddModal('info')">+ Add info</button>
    </div>

  </div>
</div>

<!-- Enhanced Modal for Adding and Editing -->
<div class="modal-overlay" id="taskModal">
  <div class="modal-content">
    <h3 id="modalTitle">Add New Task</h3>
    
    <div class="input-group">
      <label>Title</label>
      <input type="text" id="taskInput" placeholder="Task name or title..." onkeypress="window.handleKeyPress(event)">
    </div>

    <div class="input-group">
      <label>Subtitle / Date (Optional)</label>
      <input type="text" id="taskSubtitle" placeholder="e.g. 24 Oct or Team Meeting" onkeypress="window.handleKeyPress(event)">
    </div>

    <div class="input-group">
      <label>Description (Optional)</label>
      <textarea id="taskBody" placeholder="Add some details, links, or notes..." rows="3"></textarea>
    </div>

    <div class="input-group">
      <label>Title Color</label>
      <div class="color-picker">
        <div class="color-swatch selected" data-color="#1D1D1F" style="background: #1D1D1F;" onclick="window.selectColor('#1D1D1F', this)"></div>
        <div class="color-swatch" data-color="#FF3B30" style="background: #FF3B30;" onclick="window.selectColor('#FF3B30', this)"></div>
        <div class="color-swatch" data-color="#FF9500" style="background: #FF9500;" onclick="window.selectColor('#FF9500', this)"></div>
        <div class="color-swatch" data-color="#34C759" style="background: #34C759;" onclick="window.selectColor('#34C759', this)"></div>
        <div class="color-swatch" data-color="#007AFF" style="background: #007AFF;" onclick="window.selectColor('#007AFF', this)"></div>
        <div class="color-swatch" data-color="#AF52DE" style="background: #AF52DE;" onclick="window.selectColor('#AF52DE', this)"></div>
        <div class="color-swatch" data-color="#FF2D55" style="background: #FF2D55;" onclick="window.selectColor('#FF2D55', this)"></div>
      </div>
    </div>

    <div class="modal-actions">
      <!-- Delete Button (Only shown when editing) -->
      <button class="modal-btn cancel" id="deleteTaskBtn" style="display: none; color: #FF3B30; margin-right: auto;" onclick="window.deleteTask()">Delete</button>
      
      <button class="modal-btn cancel" onclick="window.closeModal()">Cancel</button>
      <button class="modal-btn primary" id="modalSubmitBtn" onclick="window.confirmTask()">Add Task</button>
    </div>
  </div>
</div>

<!-- Application Logic -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
  import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

  // --- 1. Global Variables ---
  let cardCounter = 14; 
  let currentTargetColumnId = null;
  let currentEditingCardId = null; 
  let selectedTaskColor = '#1D1D1F'; 
  let isFirebaseInitialized = false;
  let isRemoteUpdate = false;
  let boardDocRef = null;

  // --- 2. Attach Core UI Functions to Window IMMEDIATELY ---
  window.allowDrop = function(ev) { ev.preventDefault(); }
  
  window.drag = function(ev) {
    ev.dataTransfer.setData("text", ev.target.id);
    setTimeout(() => { ev.target.style.opacity = '0.5'; }, 0);
  }

  window.dragEnter = function(ev) {
    ev.preventDefault();
    const dropZone = ev.target.closest('.card-container');
    if (dropZone) dropZone.classList.add('drag-over');
  }

  window.dragLeave = function(ev) {
    const dropZone = ev.target.closest('.card-container');
    if (dropZone) dropZone.classList.remove('drag-over');
  }

  window.drop = function(ev) {
    ev.preventDefault();
    const data = ev.dataTransfer.getData("text");
    const draggedElement = document.getElementById(data);
    if (!draggedElement) return;

    draggedElement.style.opacity = '1';
    const dropZone = ev.target.closest('.card-container');
    if (dropZone) {
        dropZone.classList.remove('drag-over');
        dropZone.appendChild(draggedElement);
        window.saveBoard(); 
    }
  }

  window.selectColor = function(color, element) {
    selectedTaskColor = color;
    document.querySelectorAll('.color-swatch').forEach(el => el.classList.remove('selected'));
    element.classList.add('selected');
  }

  window.openAddModal = function(columnId) {
    currentTargetColumnId = columnId;
    currentEditingCardId = null; 
    
    const modal = document.getElementById('taskModal');
    document.getElementById('modalTitle').textContent = 'Add New Task';
    document.getElementById('modalSubmitBtn').textContent = 'Add Task';
    document.getElementById('deleteTaskBtn').style.display = 'none';

    document.getElementById('taskInput').value = '';
    document.getElementById('taskSubtitle').value = '';
    document.getElementById('taskBody').value = '';
    
    selectedTaskColor = '#1D1D1F';
    document.querySelectorAll('.color-swatch').forEach(el => el.classList.remove('selected'));
    document.querySelector('.color-swatch[data-color="#1D1D1F"]').classList.add('selected');

    modal.classList.add('active');
    setTimeout(() => document.getElementById('taskInput').focus(), 50); 
  }

  window.openEditModal = function(card) {
    currentTargetColumnId = null;
    currentEditingCardId = card.id;
    
    const modal = document.getElementById('taskModal');
    document.getElementById('modalTitle').textContent = 'Edit Task';
    document.getElementById('modalSubmitBtn').textContent = 'Save Changes';
    document.getElementById('deleteTaskBtn').style.display = 'block';

    const titleEl = card.querySelector('.card-title');
    const subtitleEl = card.querySelector('.card-subtitle');
    const bodyEl = card.querySelector('.card-body');

    document.getElementById('taskInput').value = titleEl ? titleEl.textContent : '';
    document.getElementById('taskSubtitle').value = subtitleEl ? subtitleEl.textContent : '';
    
    if (bodyEl) {
      document.getElementById('taskBody').value = bodyEl.innerHTML.replace(/<br\s*[\/]?>/gi, "\n");
    } else {
      document.getElementById('taskBody').value = '';
    }

    selectedTaskColor = titleEl ? (titleEl.getAttribute('data-color') || '#1D1D1F') : '#1D1D1F';
    document.querySelectorAll('.color-swatch').forEach(el => el.classList.remove('selected'));
    const swatch = document.querySelector(`.color-swatch[data-color="${selectedTaskColor}"]`);
    if (swatch) swatch.classList.add('selected');
    else document.querySelector('.color-swatch[data-color="#1D1D1F"]').classList.add('selected');

    modal.classList.add('active');
    setTimeout(() => document.getElementById('taskInput').focus(), 50);
  }

  window.closeModal = function() {
    document.getElementById('taskModal').classList.remove('active');
    currentTargetColumnId = null;
    currentEditingCardId = null;
  }

  window.handleKeyPress = function(event) {
    if (event.key === 'Enter') window.confirmTask();
  }

  window.deleteTask = function() {
    if (currentEditingCardId) {
      const card = document.getElementById(currentEditingCardId);
      if (card) {
        card.remove();
        window.saveBoard(); 
      }
    }
    window.closeModal();
  }

  window.confirmTask = function() {
    const title = document.getElementById('taskInput').value.trim();
    const subtitle = document.getElementById('taskSubtitle').value.trim();
    const body = document.getElementById('taskBody').value.trim();
    
    if (!title) return;

    if (currentEditingCardId) {
      const card = document.getElementById(currentEditingCardId);
      
      let titleEl = card.querySelector('.card-title');
      if (!titleEl) {
          titleEl = document.createElement('p');
          titleEl.className = 'card-title';
          card.insertBefore(titleEl, card.firstChild);
      }
      titleEl.textContent = title;
      titleEl.style.color = selectedTaskColor;
      titleEl.setAttribute('data-color', selectedTaskColor);

      let subtitleEl = card.querySelector('.card-subtitle');
      if (subtitle) {
          if (!subtitleEl) {
              subtitleEl = document.createElement('p');
              subtitleEl.className = 'card-subtitle';
              titleEl.insertAdjacentElement('afterend', subtitleEl);
          }
          subtitleEl.textContent = subtitle;
      } else if (subtitleEl) {
          if (subtitleEl) subtitleEl.remove();
      }

      let bodyEl = card.querySelector('.card-body');
      if (body) {
          if (!bodyEl) {
              bodyEl = document.createElement('p');
              bodyEl.className = 'card-body';
              const selectEl = card.querySelector('.assignee-select');
              card.insertBefore(bodyEl, selectEl);
          }
          bodyEl.innerHTML = body.replace(/\n/g, '<br>');
      } else if (bodyEl) {
          if (bodyEl) bodyEl.remove();
      }

      window.closeModal();
      window.saveBoard();

    } else {
      if (!currentTargetColumnId) return;
      const container = document.getElementById(currentTargetColumnId);
      
      const newCard = document.createElement('div');
      newCard.className = 'card';
      newCard.draggable = true;
      newCard.id = 'card' + cardCounter;
      newCard.ondragstart = window.drag;

      let innerHTML = `<p class="card-title" style="color: ${selectedTaskColor};" data-color="${selectedTaskColor}">${title}</p>`;
      if (subtitle) innerHTML += `<p class="card-subtitle">${subtitle}</p>`;
      if (body) {
        const formattedBody = body.replace(/\n/g, '<br>');
        innerHTML += `<p class="card-body">${formattedBody}</p>`;
      }

      innerHTML += `
        <select class="assignee-select">
          <option value="" disabled selected>Assegna a...</option>
          <option value="inc">INC</option>
          <option value="mate">MATE</option>
          <option value="zollo">Zollo</option>
          <option value="clg">CLG</option>
          <option value="comitato">Comitato</option>
          <option value="tutti">Tutti</option>
        </select>
      `;

      newCard.innerHTML = innerHTML;
      container.appendChild(newCard);
      
      cardCounter++;
      window.closeModal();
      window.saveBoard(); 
    }
  }

  // --- 3. Event Listeners ---
  document.addEventListener('dragend', function(ev) {
    if (ev.target.classList.contains('card')) ev.target.style.opacity = '1';
    document.querySelectorAll('.card-container').forEach(c => c.classList.remove('drag-over'));
  });

  document.addEventListener('change', function(e) {
    if (e.target.classList.contains('assignee-select')) {
      window.saveBoard();
    }
  });

  document.addEventListener('click', function(e) {
    const card = e.target.closest('.card');
    const isSelect = e.target.closest('.assignee-select'); 
    if (card && !isSelect) window.openEditModal(card);
  });

  // --- 4. State Management (Save/Load) ---
  function getBoardState() {
    const state = {};
    document.querySelectorAll('.card-container').forEach(container => {
      const colId = container.id;
      state[colId] = [];
      container.querySelectorAll('.card').forEach(card => {
        state[colId].push({
          id: card.id,
          title: card.querySelector('.card-title')?.textContent || '',
          color: card.querySelector('.card-title')?.getAttribute('data-color') || '#1D1D1F',
          subtitle: card.querySelector('.card-subtitle')?.textContent || '',
          body: card.querySelector('.card-body')?.innerHTML || '',
          assignee: card.querySelector('.assignee-select')?.value || ''
        });
      });
    });
    return state;
  }

  function renderBoardState(state) {
    for (const [colId, cards] of Object.entries(state)) {
      const container = document.getElementById(colId);
      if (!container) continue;
      container.innerHTML = ''; 
      
      cards.forEach(cardData => {
        const card = document.createElement('div');
        card.className = 'card';
        card.draggable = true;
        card.id = cardData.id;
        card.ondragstart = window.drag; 

        let innerHTML = `<p class="card-title" style="color: ${cardData.color};" data-color="${cardData.color}">${cardData.title}</p>`;
        if (cardData.subtitle) innerHTML += `<p class="card-subtitle">${cardData.subtitle}</p>`;
        if (cardData.body) innerHTML += `<p class="card-body">${cardData.body}</p>`;

        innerHTML += `
          <select class="assignee-select">
            <option value="" disabled ${!cardData.assignee ? 'selected' : ''}>Assegna a...</option>
            <option value="inc" ${cardData.assignee === 'inc' ? 'selected' : ''}>INC</option>
            <option value="mate" ${cardData.assignee === 'mate' ? 'selected' : ''}>MATE</option>
            <option value="zollo" ${cardData.assignee === 'zollo' ? 'selected' : ''}>Zollo</option>
            <option value="clg" ${cardData.assignee === 'clg' ? 'selected' : ''}>CLG</option>
            <option value="comitato" ${cardData.assignee === 'comitato' ? 'selected' : ''}>Comitato</option>
            <option value="tutti" ${cardData.assignee === 'tutti' ? 'selected' : ''}>Tutti</option>
          </select>
        `;

        card.innerHTML = innerHTML;
        container.appendChild(card);
      });
    }

    const allCards = document.querySelectorAll('.card');
    if (allCards.length > 0) {
       const ids = Array.from(allCards).map(c => parseInt(c.id.replace('card', '')) || 0);
       cardCounter = Math.max(...ids) + 1;
    }
  }

  window.saveBoard = async function() {
    if (isRemoteUpdate || !isFirebaseInitialized || !boardDocRef) return;
    
    const state = getBoardState();
    
    try {
      await setDoc(boardDocRef, state);
    } catch(e) { console.error("Firebase save error", e); }
  }


  // --- 5. Initialize Cloud Firebase ---
  
  // To make this board work permanently for EVERYONE on GitHub Pages,
  // you must link it to a free database. 
  
  let firebaseConfig = {};

  if (typeof __firebase_config !== 'undefined') {
    // We are running inside the temporary preview environment here
    firebaseConfig = JSON.parse(__firebase_config);
  } else {
    // We are running on GitHub Pages!
    // üëá PASTE YOUR FREE FIREBASE CONFIGURATION HERE üëá
    firebaseConfig = {
      apiKey: "AIzaSyCJnQ1LS9ZURc02rGrLeT94VkJMKSPYHhs",
      authDomain: "prova-37426.firebaseapp.com",
      projectId: "prova-37426",
      storageBucket: "prova-37426.firebasestorage.app",
      messagingSenderId: "509040852095",
      appId: "1:509040852095:web:ba7e3ad7c88438aa5ed34a"
    };
    // üëÜ -------------------------------------------- üëÜ
  }

  // Only boot up the real-time sync if a database configuration exists
  if (firebaseConfig && Object.keys(firebaseConfig).length > 0 && firebaseConfig.projectId) {
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'parma-dashboard';
    boardDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'boards', 'main_board');

    // Messo in sicurezza l'ordine di caricamento per GitHub Pages
    const initFirebase = async () => {
      try {
        // 1. Aspetta che l'autenticazione anonima sia COMPLETATA
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }
        
        // 2. Solo ORA diamo il via libera ai salvataggi
        isFirebaseInitialized = true;
        
        // 3. Scarica i dati dal Cloud in tempo reale
        onSnapshot(boardDocRef, (snapshot) => {
          if (snapshot.exists()) {
            isRemoteUpdate = true;
            const data = snapshot.data();
            if (data) renderBoardState(data);
            setTimeout(() => isRemoteUpdate = false, 100);
          } else {
            // Se il database √® vuoto (primo avvio), salvaci dentro le card di base!
            window.saveBoard();
          }
        }, (error) => console.error("Sync error", error));
        
      } catch(e) { console.error("Firebase connection error", e); }
    };

    // Avvia la connessione sicura
    initFirebase();
  } else {
    console.warn("No Firebase configuration found.");
  }

</script>
</body>
</html>
